<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>SheetCraft AI</title>
        <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    </head>
    <body>
        <main id="app-body" style="display: none;">
            <header class="app-header">
                <div class="brand">
                    <div class="logo" id="logo-icon"></div>
                    <h1>SheetCraft <span class="highlight-text">AI</span></h1>
                </div>
                <div class="header-actions">
                    <button id="docs-toggle" class="btn-icon" title="What can I do?"></button>
                    <button id="settings-toggle" class="btn-icon" title="Settings"></button>
                </div>
            </header>

            <!-- Docs Panel -->
            <div id="docs-panel" class="panel" style="display: none;">
                <h3>What can SheetCraft AI do?</h3>
                <div class="docs-grid">
                    <div class="doc-item"><span class="doc-icon" data-icon="paintbrush"></span><div><strong>Smart Formatter</strong><p>Say "make this professional" and get instant clean formatting, spacing, fonts, colors, alignment</p></div></div>
                    <div class="doc-item"><span class="doc-icon" data-icon="formula"></span><div><strong>Formula Generator</strong><p>Describe what you need in plain English â€” get VLOOKUP, SUMIF, INDEX/MATCH, any formula</p></div></div>
                    <div class="doc-item"><span class="doc-icon" data-icon="barChart"></span><div><strong>Report Automation</strong><p>Generate monthly sales, financial, or performance reports with charts in one click</p></div></div>
                    <div class="doc-item"><span class="doc-icon" data-icon="table"></span><div><strong>Tables & Charts</strong><p>Create formatted tables, column/bar/line/pie charts, dashboards</p></div></div>
                    <div class="doc-item"><span class="doc-icon" data-icon="sortAsc"></span><div><strong>Sort & Filter</strong><p>Sort by any column, apply AutoFilter, multi-column sorting</p></div></div>
                    <div class="doc-item"><span class="doc-icon" data-icon="checkSquare"></span><div><strong>Validation</strong><p>Dropdown lists, number constraints, date limits, error alerts</p></div></div>
                    <div class="doc-item"><span class="doc-icon" data-icon="trendUp"></span><div><strong>Conditional Formatting</strong><p>Color scales, data bars, icon sets, highlight rules</p></div></div>
                    <div class="doc-item"><span class="doc-icon" data-icon="eraser"></span><div><strong>Data Cleanup</strong><p>Remove duplicates, trim spaces, fix formats, standardize case</p></div></div>
                    <div class="doc-item"><span class="doc-icon" data-icon="snowflake"></span><div><strong>Freeze & Protect</strong><p>Freeze header rows, protect sheets with custom permissions</p></div></div>
                    <div class="doc-item"><span class="doc-icon" data-icon="columns"></span><div><strong>Worksheets</strong><p>Add, rename, delete, copy sheets, change tab colors</p></div></div>
                    <div class="doc-item"><span class="doc-icon" data-icon="fileTemplate"></span><div><strong>Templates</strong><p>Budget trackers, invoices, employee lists, project trackers, grade books</p></div></div>
                </div>
                <p class="docs-hint">Just describe what you need in plain English â€” SheetCraft handles the rest.</p>
            </div>

            <!-- Settings Panel -->
            <div id="settings-panel" class="panel" style="display: none;">
                <h3>AI Provider</h3>
                
                <div class="form-group">
                    <label for="setting-provider">Provider</label>
                    <select id="setting-provider" class="form-input">
                        <option value="groq">Groq (Cloud)</option>
                        <option value="local">Ollama (Local)</option>
                    </select>
                </div>

                <div id="groq-fields">
                    <div class="form-group">
                        <label for="setting-api-key">API Key</label>
                        <input id="setting-api-key" type="password" class="form-input" placeholder="gsk_..." />
                    </div>
                    <div class="form-group">
                        <label for="setting-groq-model">Model</label>
                        <select id="setting-groq-model" class="form-input">
                            <option value="llama-3.1-8b-instant" selected>Llama 3.1 8B â€” Fast (131K TPM)</option>
                            <option value="llama-3.3-70b-versatile">Llama 3.3 70B â€” Smart (12K TPM)</option>
                            <option value="gemma2-9b-it">Gemma 2 9B (15K TPM)</option>
                            <option value="mixtral-8x7b-32768">Mixtral 8x7B (5K TPM)</option>
                        </select>
                    </div>
                </div>

                <div id="local-fields" style="display: none;">
                    <div class="form-group">
                        <label for="setting-base-url">Ollama Host</label>
                        <input id="setting-base-url" type="text" class="form-input" placeholder="http://localhost:11434" />
                    </div>
                    <div class="form-group">
                        <label>Model</label>
                        <div class="model-select-wrapper">
                            <select id="setting-local-model" class="form-input">
                                <option value="" disabled selected>Click refresh â†’</option>
                            </select>
                            <button id="refresh-models" class="btn-icon btn-refresh" title="Refresh models"></button>
                        </div>
                        <div id="model-status" class="model-status"></div>
                    </div>
                </div>

                <button id="save-settings" class="btn-primary btn-save">Save</button>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- MODE TOGGLE -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="mode-toggle">
                <button id="mode-planning" class="mode-tab active" data-mode="planning">
                    <span id="mode-planning-icon"></span>
                    <span>Planning</span>
                </button>
                <button id="mode-agent" class="mode-tab" data-mode="agent">
                    <span id="mode-agent-icon"></span>
                    <span>Agent</span>
                </button>
                <div class="mode-indicator" id="mode-indicator"></div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- PLANNING MODE (Chat) -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="planning-mode" class="mode-content active">
                <!-- Chat Messages Area -->
                <div id="chat-messages" class="chat-messages">
                    <!-- Welcome message -->
                    <div class="chat-welcome">
                        <div class="welcome-icon" id="welcome-sparkle"></div>
                        <h2>What are you working on?</h2>
                        <p>I'm your spreadsheet thinking partner. Ask me about formulas, data strategies, best practices, or let me help you plan your next step.</p>
                        <div class="welcome-suggestions" id="chat-suggestions">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="chat-input-area">
                    <!-- File Preview -->
                    <div id="file-preview-container" class="file-preview" style="display: none;">
                        <div class="file-thumb">
                            <span id="file-preview-icon"></span>
                            <span id="file-preview-name" class="file-name">filename.pdf</span>
                            <button id="file-remove" class="file-remove">Ã—</button>
                        </div>
                    </div>
                    
                    <div class="chat-input-card">
                        <input type="file" id="file-input" accept="image/png, image/jpeg, application/pdf" style="display: none;" />
                        <button id="file-upload-btn" class="btn-clip" title="Attach Image or PDF">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                        </button>
                        <textarea id="chat-input" placeholder="Ask or upload file..." rows="1" spellcheck="false"></textarea>
                        <button id="chat-send" class="btn-send" title="Send message">
                            <span id="chat-send-icon"></span>
                        </button>
                    </div>
                    <div class="chat-footer">
                        <button id="chat-clear" class="btn-text" title="Clear conversation">
                            <span id="chat-clear-icon"></span>
                            <span>Clear</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- AGENT MODE (Execute) -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="agent-mode" class="mode-content">
                <div class="content-wrapper">
                    <div class="input-card">
                        <textarea id="prompt-input" placeholder="Describe what you want to do in Excel..." spellcheck="false"></textarea>
                        
                        <!-- File Preview (Agent Mode) -->
                        <div id="agent-file-preview" class="file-preview" style="display: none; margin-top: 8px;">
                            <div class="file-thumb">
                                <span class="upload-icon-svg">ðŸ“„</span>
                                <span id="agent-file-name" class="file-name">filename.pdf</span>
                                <button id="agent-file-remove" class="file-remove">Ã—</button>
                            </div>
                        </div>

                        <div class="card-footer">
                            <div class="footer-left">
                                <input type="file" id="agent-file-input" accept="image/png, image/jpeg, application/pdf" style="display: none;" />
                                <button id="agent-file-btn" class="btn-clip" title="Extract from Image/PDF">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                                </button>
                                <span id="cache-badge" class="cache-badge" style="display:none;">âš¡ cached</span>
                            </div>
                            <button id="run" class="btn-primary">
                                <span>Execute</span>
                                <span id="run-icon"></span>
                            </button>
                        </div>
                    </div>

                    <!-- Category Tabs for Quick Actions -->
                    <div class="action-categories" id="action-categories">
                        <button class="category-tab active" data-category="cleanup">
                            <span class="cat-icon" data-icon="broom"></span>
                            <span>Cleanup</span>
                        </button>
                        <button class="category-tab" data-category="formulas">
                            <span class="cat-icon" data-icon="formula"></span>
                            <span>Formulas</span>
                        </button>
                        <button class="category-tab" data-category="format">
                            <span class="cat-icon" data-icon="palette"></span>
                            <span>Format</span>
                        </button>
                        <button class="category-tab" data-category="reports">
                            <span class="cat-icon" data-icon="barChart"></span>
                            <span>Reports</span>
                        </button>
                        <button class="category-tab" data-category="templates">
                            <span class="cat-icon" data-icon="fileTemplate"></span>
                            <span>Templates</span>
                        </button>
                    </div>

                    <!-- Quick Actions -->
                    <div id="quick-actions" class="quick-actions"></div>

                    <!-- Skeleton (shown during loading) -->
                    <div id="skeleton" class="skeleton-container" style="display: none;">
                        <div class="skeleton-pill"></div>
                        <div class="skeleton-line w80"></div>
                        <div class="skeleton-line w60"></div>
                    </div>

                    <!-- Status Message -->
                    <div id="status-message" class="status-pill"></div>

                    <!-- Debug -->
                    <div id="debug-section">
                        <details>
                            <summary>
                                <span id="chevron-icon"></span>
                                <span>Generated Code</span>
                            </summary>
                            <pre id="debug-code"></pre>
                        </details>
                    </div>
                </div>
            </div>
        </main>
        
        <section id="sideload-msg" class="sideload-container">
            <!-- Skeleton UI mimicking the real app layout -->
            <div class="sideload-skeleton">
                <!-- Skeleton Header -->
                <div class="sk-header">
                    <div class="sk-brand">
                        <div class="sk-logo sk-shimmer"></div>
                        <div class="sk-title sk-shimmer"></div>
                    </div>
                    <div class="sk-header-actions">
                        <div class="sk-icon-btn sk-shimmer"></div>
                        <div class="sk-icon-btn sk-shimmer"></div>
                    </div>
                </div>

                <!-- Skeleton Mode Toggle -->
                <div class="sk-mode-toggle">
                    <div class="sk-mode-tab sk-shimmer"></div>
                    <div class="sk-mode-tab sk-shimmer"></div>
                </div>

                <!-- Skeleton Welcome -->
                <div class="sk-welcome">
                    <div class="sk-welcome-icon sk-shimmer"></div>
                    <div class="sk-welcome-title sk-shimmer"></div>
                    <div class="sk-welcome-desc sk-shimmer"></div>
                    <div class="sk-welcome-desc short sk-shimmer"></div>
                </div>

                <!-- Skeleton Suggestions -->
                <div class="sk-suggestions">
                    <div class="sk-suggestion sk-shimmer"></div>
                    <div class="sk-suggestion sk-shimmer"></div>
                    <div class="sk-suggestion sk-shimmer"></div>
                    <div class="sk-suggestion sk-shimmer"></div>
                </div>

                <!-- Skeleton Input -->
                <div class="sk-input-area">
                    <div class="sk-input sk-shimmer"></div>
                </div>

                <!-- Loading Status -->
                <div class="sideload-status" id="loading-status">
                    <div class="sideload-pulse"></div>
                    <span id="loading-text">Initializing SheetCraft...</span>
                </div>
                
                <!-- Fallback Script for Loading Issues -->
                <script>
                    setTimeout(function() {
                        var appBody = document.getElementById("app-body");
                        if (!appBody || appBody.style.display === "none") {
                            var status = document.getElementById("loading-status");
                            if (status) {
                                document.getElementById("loading-text").innerText = "Taking a while...";
                                var help = document.createElement("div");
                                help.style.cssText = "margin-top:12px;font-size:11px;color:#d32f2f;background:#ffebee;padding:8px;border-radius:6px;max-width:260px;line-height:1.4;";
                                help.innerHTML = "<strong>Stuck?</strong><br>1. Open this link in Edge/Chrome<br>2. Accept 'Unsafe' certificate<br>3. Restart Excel";
                                
                                var link = document.createElement("a");
                                link.href = "https://localhost:3000/taskpane.html";
                                link.target = "_blank";
                                link.innerText = "Open Debug Link";
                                link.style.cssText = "display:block;margin-top:8px;font-weight:600;color:#d32f2f;text-decoration:underline;";
                                
                                help.appendChild(link);
                                status.appendChild(help);
                            }
                        }
                    }, 4000); // Show help after 4 seconds
                </script>
            </div>
        </section>
    </body>
</html>
